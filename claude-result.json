{
  "name": "COTI Transaction Notifier",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Poll Every 5 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "url": "https://mainnet.cotiscan.io/api/v2/addresses/YOUR_WALLET_ADDRESS/transactions",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "http-request",
      "name": "Fetch COTI Transactions",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// COTI Transaction Processor\n// Tracks seen transactions and detects new ones\n\nconst WALLET_ADDRESS = 'YOUR_WALLET_ADDRESS'.toLowerCase();\nconst DECIMALS = 18; // COTI has 18 decimals\n\n// Get workflow static data for persistence between executions\nconst staticData = $getWorkflowStaticData('global');\n\n// Initialize seen transactions set if it doesn't exist\nif (!staticData.seenTransactions) {\n  staticData.seenTransactions = [];\n}\n\n// Get transactions from the API response\nconst apiResponse = $input.first().json;\nlet transactions = [];\n\n// Handle different response formats\nif (Array.isArray(apiResponse)) {\n  // Response is array with items property\n  if (apiResponse[0] && apiResponse[0].items) {\n    transactions = apiResponse[0].items;\n  } else {\n    transactions = apiResponse;\n  }\n} else if (apiResponse.items) {\n  transactions = apiResponse.items;\n} else if (apiResponse.result) {\n  transactions = apiResponse.result;\n}\n\n// Filter for new transactions only\nconst seenSet = new Set(staticData.seenTransactions);\nconst newTransactions = transactions.filter(tx => !seenSet.has(tx.hash));\n\n// If no new transactions, return early with flag\nif (newTransactions.length === 0) {\n  return [{\n    json: {\n      hasNew: false,\n      message: 'No new transactions',\n      newCount: 0\n    }\n  }];\n}\n\n// Helper function to format COTI amount from wei\nfunction formatCotiAmount(weiValue) {\n  if (!weiValue) return '0';\n  const wei = BigInt(weiValue);\n  const divisor = BigInt(10 ** DECIMALS);\n  const wholePart = wei / divisor;\n  const fractionalPart = wei % divisor;\n  \n  // Format with up to 6 decimal places\n  const fractionalStr = fractionalPart.toString().padStart(DECIMALS, '0').slice(0, 6);\n  const trimmedFractional = fractionalStr.replace(/0+$/, '');\n  \n  if (trimmedFractional) {\n    return `${wholePart}.${trimmedFractional}`;\n  }\n  return wholePart.toString();\n}\n\n// Helper function to truncate address\nfunction truncateAddress(address) {\n  if (!address) return 'Unknown';\n  return `${address.slice(0, 6)}...${address.slice(-4)}`;\n}\n\n// Helper function to format timestamp\nfunction formatTimestamp(timestamp) {\n  if (!timestamp) return 'Unknown';\n  const date = new Date(timestamp);\n  return date.toLocaleString('en-US', {\n    year: 'numeric',\n    month: 'short',\n    day: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit',\n    timeZoneName: 'short'\n  });\n}\n\n// Process each new transaction and build messages\nconst results = newTransactions.map(tx => {\n  const fromAddress = tx.from?.hash?.toLowerCase() || '';\n  const toAddress = tx.to?.hash?.toLowerCase() || '';\n  \n  // Determine direction\n  const isOutgoing = fromAddress === WALLET_ADDRESS;\n  const isIncoming = toAddress === WALLET_ADDRESS;\n  \n  let direction = 'ðŸ”„';\n  let directionText = 'Self Transfer';\n  \n  if (isOutgoing && !isIncoming) {\n    direction = 'ðŸ“¤';\n    directionText = 'Outgoing';\n  } else if (isIncoming && !isOutgoing) {\n    direction = 'ðŸ“¥';\n    directionText = 'Incoming';\n  }\n  \n  // Format values\n  const amount = formatCotiAmount(tx.value);\n  const fee = formatCotiAmount(tx.fee?.value);\n  const fromTruncated = truncateAddress(tx.from?.hash);\n  const toTruncated = truncateAddress(tx.to?.hash);\n  const timestamp = formatTimestamp(tx.timestamp);\n  const explorerLink = `https://mainnet.cotiscan.io/tx/${tx.hash}`;\n  \n  // Build formatted message\n  const message = `${direction} *${directionText} Transaction*\n\n` +\n    `ðŸ’° *Amount:* ${amount} COTI\\n` +\n    `ðŸ“ *From:* \\`${fromTruncated}\\`\\n` +\n    `ðŸ“ *To:* \\`${toTruncated}\\`\\n` +\n    `ðŸ§± *Block:* ${tx.block_number || 'Pending'}\\n` +\n    `â›½ *Fee:* ${fee} COTI\\n` +\n    `ðŸ• *Time:* ${timestamp}\\n` +\n    `âœ… *Status:* ${tx.status || 'Unknown'}\\n\\n` +\n    `ðŸ”— [View on CotiScan](${explorerLink})`;\n  \n  // Add to seen transactions\n  staticData.seenTransactions.push(tx.hash);\n  \n  return {\n    json: {\n      hasNew: true,\n      message: message,\n      hash: tx.hash,\n      direction: directionText,\n      amount: amount,\n      from: tx.from?.hash,\n      to: tx.to?.hash,\n      blockNumber: tx.block_number,\n      fee: fee,\n      timestamp: tx.timestamp,\n      explorerLink: explorerLink\n    }\n  };\n});\n\n// Limit stored transactions to prevent memory bloat (keep last 1000)\nif (staticData.seenTransactions.length > 1000) {\n  staticData.seenTransactions = staticData.seenTransactions.slice(-1000);\n}\n\nreturn results;"
      },
      "id": "code-processor",
      "name": "Process Transactions",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-has-new",
              "leftValue": "={{ $json.hasNew }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-has-new",
      "name": "Has New Transactions?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": false
        }
      },
      "id": "telegram-send",
      "name": "Send Telegram Notification",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1120,
        200
      ],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {},
      "id": "no-op-node",
      "name": "No New Transactions",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1120,
        400
      ]
    }
  ],
  "connections": {
    "Poll Every 5 Minutes": {
      "main": [
        [
          {
            "node": "Fetch COTI Transactions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch COTI Transactions": {
      "main": [
        [
          {
            "node": "Process Transactions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Transactions": {
      "main": [
        [
          {
            "node": "Has New Transactions?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has New Transactions?": {
      "main": [
        [
          {
            "node": "Send Telegram Notification",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No New Transactions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "blockchain",
      "id": "tag-blockchain"
    },
    {
      "name": "notifications",
      "id": "tag-notifications"
    }
  ],
  "triggerCount": 1
}